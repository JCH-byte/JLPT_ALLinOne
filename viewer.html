<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JLPT Viewer</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="viewer-mode">
    
    <div id="viewer-content">
        <header class="viewer-header">
            <div class="header-badges">
                <span class="badge-level" id="badge-level">JLPT</span>
            </div>
            <h1 id="header-title">Loading...</h1>
        </header>

        <!-- Section 1: Story & Analysis -->
        <section id="section-story" class="study-section" style="display:none;">
            <h2 class="section-title"><i class="fas fa-book-open"></i> ë¬¸ë§¥ í•™ìŠµ</h2>
            <div id="story-content" class="story-box"></div>
            
            <!-- êµ¬ë¬¸ ë¶„ì„ ì˜ì—­ -->
            <div id="analysis-wrapper" style="margin-top: 30px; display:none;">
                <h3 class="sub-title" style="font-size:1.1rem; color:#555; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px;">
                    ğŸ“Œ êµ¬ë¬¸ ë¶„ì„
                </h3>
                <div id="analysis-list" class="analysis-container"></div>
            </div>
        </section>

        <!-- Section 2: Vocabulary -->
        <section id="section-vocab" class="study-section">
            <h2 class="section-title"><i class="fas fa-layer-group"></i> ë‹¨ì–´ í•™ìŠµ</h2>
            <div class="card-container">
                <button class="nav-arrow left" onclick="prevCard()">â®</button>
                <div class="flashcard" id="flashcard" onclick="flipCard()">
                    <div class="card-face card-front"></div>
                    <div class="card-face card-back"></div>
                </div>
                <button class="nav-arrow right" onclick="nextCard()">â¯</button>
            </div>
            <div id="card-counter" class="card-counter">0 / 0</div>
            <p class="card-tip">ì¹´ë“œë¥¼ í´ë¦­í•˜ë©´ ëœ»ê³¼ ì˜ˆë¬¸ì´ ë‚˜ì˜µë‹ˆë‹¤.</p>
        </section>

        <!-- Section 3: Quiz -->
        <section id="section-quiz" class="study-section" style="display:none;">
            <h2 class="section-title"><i class="fas fa-pencil-alt"></i> ì‹¤ë ¥ í™•ì¸</h2>
            <div id="quiz-container" class="quiz-container"></div>
        </section>

        <!-- Navigation -->
        <div class="nav-buttons">
            <a href="#" id="btn-prev" class="nav-btn prev" onclick="navigateDay(-1)">Prev</a>
            <a href="index.html" target="_parent" class="nav-btn list"><i class="fas fa-bars"></i> ëª©ë¡</a>
            <a href="#" id="btn-next" class="nav-btn next" onclick="navigateDay(1)">Next</a>
        </div>
    </div>

    <script src="n5_data.js"></script>
    <script src="common.js"></script>
    
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const level = urlParams.get('level') || 'n5';
        const day = urlParams.get('day') || '1';

        document.addEventListener('DOMContentLoaded', () => {
            document.body.setAttribute('data-theme', level);
            document.getElementById('badge-level').textContent = level.toUpperCase();
            loadDayData(level, day);
        });

        function loadDayData(lvl, d) {
            const varName = `${lvl.toUpperCase()}_DATA`;
            const allData = window[varName];

            if (!allData || !allData[d]) {
                document.getElementById('header-title').textContent = "ë°ì´í„° ì—†ìŒ";
                return;
            }

            const current = allData[d];
            document.getElementById('header-title').textContent = `Day ${d} í•™ìŠµ`;

            // 1. ìŠ¤í† ë¦¬ ë° êµ¬ë¬¸ ë¶„ì„ ë Œë”ë§
            const storySection = document.getElementById('section-story');
            const storyContent = document.getElementById('story-content');
            const analysisWrapper = document.getElementById('analysis-wrapper');
            const analysisList = document.getElementById('analysis-list');

            // Storyê°€ ìˆê±°ë‚˜ Analysisê°€ ìˆìœ¼ë©´ ì„¹ì…˜ í‘œì‹œ
            // (ë°ì´í„° êµ¬ì¡° ìœ ì—°ì„±: current.storyê°€ ë¬¸ìì—´ì¼ ìˆ˜ë„, ê°ì²´ì¼ ìˆ˜ë„ ìˆìŒ)
            let storyText = "";
            let analysisData = [];

            if (current.story) {
                if (typeof current.story === 'string') {
                    storyText = current.story;
                } else if (typeof current.story === 'object') {
                    storyText = current.story.content || current.story.text || "";
                    analysisData = current.story.analysis || [];
                }
            }
            // ìµœìƒìœ„ì— analysisê°€ ìˆì„ ê²½ìš°ë„ ì²´í¬
            if (!analysisData.length && current.analysis) {
                analysisData = current.analysis;
            }

            if (storyText || analysisData.length > 0) {
                storySection.style.display = 'block';
                
                // ë³¸ë¬¸ ì¶œë ¥
                if (storyText) {
                    storyContent.innerHTML = storyText.replace(/\n/g, '<br>');
                    storyContent.style.display = 'block';
                } else {
                    storyContent.style.display = 'none';
                }

                // [í•µì‹¬] êµ¬ë¬¸ ë¶„ì„ ë Œë”ë§
                if (analysisData.length > 0) {
                    analysisWrapper.style.display = 'block';
                    analysisList.innerHTML = ""; // ì´ˆê¸°í™”

                    analysisData.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'analysis-card';

                        // ê¸°ë³¸ ë¬¸ì¥ ë° í•´ì„
                        let html = `
                            <div class="an-sent">${item.sent || item.sentence}</div>
                            <div class="an-mean">${item.mean || item.meaning}</div>
                        `;

                        // [ìš”ì²­í•˜ì‹  ë¶€ë¶„] grammar í•„ë“œê°€ ìˆìœ¼ë©´ ì•„ë˜ì— ì¶œë ¥
                        // ì˜ˆ: "grammar": "ì¢…ì¡°ì‚¬ ã­" -> í™”ë©´ì— í‘œì‹œ
                        if (item.grammar) {
                            html += `
                                <div class="an-grammar">
                                    <i class="fas fa-check-circle"></i> ${item.grammar}
                                </div>
                            `;
                        }

                        div.innerHTML = html;
                        analysisList.appendChild(div);
                    });
                } else {
                    analysisWrapper.style.display = 'none';
                }

            } else {
                storySection.style.display = 'none';
            }

            // 2. ë‹¨ì–´ì¥
            if (current.vocab) renderFlashcards(current.vocab);

            // 3. í€´ì¦ˆ
            // (common.jsì— renderQuizê°€ ìˆë‹¤ê³  ê°€ì •í•˜ê±°ë‚˜ ì—¬ê¸°ì„œ ê°„ë‹¨ êµ¬í˜„)
            const quizSection = document.getElementById('section-quiz');
            if (current.quiz && current.quiz.length > 0) {
                quizSection.style.display = 'block';
                const qContainer = document.getElementById('quiz-container');
                // ê¸°ì¡´ renderQuizê°€ ìˆë‹¤ë©´ í˜¸ì¶œ, ì—†ìœ¼ë©´ ê°„ë‹¨íˆ ë¿Œë¦¬ê¸°
                if(typeof renderQuiz === 'function') {
                    renderQuiz(current.quiz);
                } else {
                    // ê°„ë‹¨ í€´ì¦ˆ ë Œë”ëŸ¬ (Fallback)
                    qContainer.innerHTML = "";
                    current.quiz.forEach((q, idx) => {
                        qContainer.innerHTML += `
                            <div style="margin-bottom:15px; padding:10px; border:1px solid #eee;">
                                <strong>Q${idx+1}. ${q.q}</strong>
                                <ul style="list-style:none; padding-left:0;">
                                    ${q.opt.map(o => `<li style="padding:5px 0;">- ${o}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    });
                }
            } else {
                quizSection.style.display = 'none';
            }
            
            updateNavButtons(lvl, d);
        }

        // ë„¤ë¹„ê²Œì´ì…˜ & ì¹´ë“œ í•¨ìˆ˜ ì—°ê²°
        function updateNavButtons(lvl, d) {
            const current = parseInt(d);
            document.getElementById('btn-prev').onclick = () => navigateDay(-1);
            document.getElementById('btn-next').onclick = () => navigateDay(1);
            
            // ì´ì „ ë²„íŠ¼ ìˆ¨ê¹€
            if (current <= 1) document.getElementById('btn-prev').style.visibility = 'hidden';
            else document.getElementById('btn-prev').style.visibility = 'visible';
            
            // ë‹¤ìŒ ë°ì´í„° ì²´í¬ (ê°„ì´)
            const allData = window[`${lvl.toUpperCase()}_DATA`];
            if (!allData || !allData[current + 1]) document.getElementById('btn-next').style.visibility = 'hidden';
            else document.getElementById('btn-next').style.visibility = 'visible';
        }

        function navigateDay(offset) {
            const newDay = parseInt(day) + offset;
            if(newDay > 0) window.location.href = `viewer.html?level=${level}&day=${newDay}`;
        }
        function flipCard() { 
            const el = document.getElementById('flashcard');
            if(el) el.classList.toggle('flipped'); 
        }
        function nextCard() { if(typeof showFlashcard === 'function') showFlashcard(currentCardIndex + 1); }
        function prevCard() { if(typeof showFlashcard === 'function') showFlashcard(currentCardIndex - 1); }

    </script>
</body>
</html>
