/**
 * admin-controller.js
 * 기능: 데이터 입력, 미리보기 저장, JSON/레거시 JS 다운로드
 */

const DEV_KEY = 'JLPT_DEV_DATA_OVERRIDE';

// 미리보기 저장 (덮어쓰기 또는 병합)
function savePreview(isMerge) {
    try {
        const levelSelect = document.getElementById('level-select');
        const input = document.getElementById('json-input');
        
        const level = levelSelect.value;
        const text = input.value;

        if (!text.trim()) {
            alert("JSON 데이터를 입력하세요.");
            return;
        }

        // JSON 유효성 검사
        const json = JSON.parse(text);
        
        // 필수 필드 확인
        if (!json.day || !json.data) {
            throw new Error('JSON에 "day"와 "data" 필드가 포함되어야 합니다.');
        }

        const day = json.day;
        const key = `${level}-${day}`;
        
        // 기존 데이터 로드
        const existing = JSON.parse(localStorage.getItem(DEV_KEY) || '{}');
        
        if (isMerge && existing[key]) {
            // 병합 모드: 기존 data 객체에 새 속성 병합
            existing[key] = { ...existing[key], ...json.data };
            alert(`[${level.toUpperCase()}] Day ${day} 데이터가 성공적으로 병합되었습니다!`);
        } else {
            // 덮어쓰기 모드
            existing[key] = json.data;
            alert(`[${level.toUpperCase()}] Day ${day} 데이터가 새로 저장되었습니다!`);
        }
        
        localStorage.setItem(DEV_KEY, JSON.stringify(existing));
        
    } catch (e) { 
        alert("오류 발생: " + e.message); 
        console.error(e);
    }
}

function buildLevelData(level) {
    const existing = JSON.parse(localStorage.getItem(DEV_KEY) || '{}');
    const levelData = {};

    Object.keys(existing).forEach(key => {
        if (key.startsWith(`${level}-`)) {
            const day = key.split('-')[1];
            levelData[day] = existing[key];
        }
    });

    return levelData;
}

function triggerDownload(content, fileName, type) {
    const blob = new Blob([content], { type });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// 표준 JSON 파일 다운로드 생성 (n4/day-03.json 규칙)
function downloadFile() {
    const level = document.getElementById('level-select').value;
    const levelData = buildLevelData(level);

    if (Object.keys(levelData).length === 0) {
        if(!confirm("저장된 프리뷰 데이터가 없습니다. 빈 파일을 생성하시겠습니까?")) return;
        triggerDownload('{}\n', `${level}.json`, "application/json");
        return;
    }

    const days = Object.keys(levelData)
        .map(day => Number(day))
        .filter(day => !Number.isNaN(day))
        .sort((a, b) => a - b);

    days.forEach(day => {
        const dayData = {
            day,
            data: levelData[String(day)]
        };
        const dayLabel = String(day).padStart(2, '0');
        const fileName = `${level}-day-${dayLabel}.json`;
        triggerDownload(`${JSON.stringify(dayData, null, 2)}\n`, fileName, "application/json");
    });
}

// 호환 옵션: 레거시 JS 파일 다운로드
function downloadLegacyJsFile() {
    const level = document.getElementById('level-select').value;
    const varName = `${level.toUpperCase()}_DATA`;
    const levelData = buildLevelData(level);

    if (Object.keys(levelData).length === 0) {
        if(!confirm("저장된 프리뷰 데이터가 없습니다. 빈 파일을 생성하시겠습니까?")) return;
    }

    const fileContent = `/**
 * JLPT ${level.toUpperCase()} Data
 * Generated by Admin Tool (Legacy JS Compatibility)
 * Updated: ${new Date().toLocaleString()}
 */
var ${varName} = ${JSON.stringify(levelData, null, 4)};
`;

    triggerDownload(fileContent, `${level}_data.js`, "text/javascript");
}

// 임시 데이터 초기화
function clearPreview() {
    if(confirm("모든 임시 데이터를 정말 삭제하시겠습니까?\n(복구할 수 없습니다)")) {
        localStorage.removeItem(DEV_KEY);
        alert("초기화 완료");
    }
}
