/**
 * admin-controller.js
 * 기능: 데이터 입력, 미리보기 저장, JS 파일 다운로드
 */

const DEV_KEY = 'JLPT_DEV_DATA_OVERRIDE';

// 미리보기 저장 (덮어쓰기 또는 병합)
function savePreview(isMerge) {
    try {
        const levelSelect = document.getElementById('level-select');
        const input = document.getElementById('json-input');
        
        const level = levelSelect.value;
        const text = input.value;

        if (!text.trim()) {
            alert("JSON 데이터를 입력하세요.");
            return;
        }

        // JSON 유효성 검사
        const json = JSON.parse(text);
        
        // 필수 필드 확인
        if (!json.day || !json.data) {
            throw new Error('JSON에 "day"와 "data" 필드가 포함되어야 합니다.');
        }

        const day = json.day;
        const key = `${level}-${day}`;
        
        // 기존 데이터 로드
        const existing = JSON.parse(localStorage.getItem(DEV_KEY) || '{}');
        
        if (isMerge && existing[key]) {
            // 병합 모드: 기존 data 객체에 새 속성 병합
            existing[key] = { ...existing[key], ...json.data };
            alert(`[${level.toUpperCase()}] Day ${day} 데이터가 성공적으로 병합되었습니다!`);
        } else {
            // 덮어쓰기 모드
            existing[key] = json.data;
            alert(`[${level.toUpperCase()}] Day ${day} 데이터가 새로 저장되었습니다!`);
        }
        
        localStorage.setItem(DEV_KEY, JSON.stringify(existing));
        
    } catch (e) { 
        alert("오류 발생: " + e.message); 
        console.error(e);
    }
}

// JS 파일 다운로드 생성
function downloadFile() {
    const level = document.getElementById('level-select').value;
    const varName = `${level.toUpperCase()}_DATA`;
    
    // 로컬 스토리지 데이터 가져오기
    const existing = JSON.parse(localStorage.getItem(DEV_KEY) || '{}');
    const levelData = {};

    // 선택된 레벨의 데이터만 필터링
    Object.keys(existing).forEach(key => {
        if (key.startsWith(`${level}-`)) {
            const day = key.split('-')[1];
            levelData[day] = existing[key];
        }
    });

    if (Object.keys(levelData).length === 0) {
        if(!confirm("저장된 프리뷰 데이터가 없습니다. 빈 파일을 생성하시겠습니까?")) return;
    }

    // 파일 콘텐츠 생성 (호환성을 위해 var 사용)
    const fileContent = `/**
 * JLPT ${level.toUpperCase()} Data
 * Generated by Admin Tool
 * Updated: ${new Date().toLocaleString()}
 */
var ${varName} = ${JSON.stringify(levelData, null, 4)};
`;

    // Blob 생성 및 다운로드 트리거
    const blob = new Blob([fileContent], { type: "text/javascript" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `${level}_data.js`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// 임시 데이터 초기화
function clearPreview() {
    if(confirm("모든 임시 데이터를 정말 삭제하시겠습니까?\n(복구할 수 없습니다)")) {
        localStorage.removeItem(DEV_KEY);
        alert("초기화 완료");
    }
}